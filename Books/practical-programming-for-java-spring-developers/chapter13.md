## 테스트 피라미드

테스트 피라미드는 테스트를 분류하는 가장 일반적이고 대중적인 분류 체계이다.

테스트 피라미드 체계에서는 테스트를 단위 테스트, 통합 테스트, E2E 테스트로 분류한다.

- **단위 테스트 (unit test)**
  - 소프트웨어를 구성하는 가장 작은 단위(unit)를 검증하는 테스트이다.
  - 'unit'이란 통상적으로 함수, 메서드, 클래스 같은 개별적이고 작은 코드 조각들을 지칭한다.
  - 객체나 컴포넌트에 할당된 작은 책임 하나가 예상대로 동작하는지 확인하는 테스트라고 볼 수 있다.
- **통합 테스트 (integration test)**
  - 여러 컴포넌트나 객체가 협력하는 상황을 검증하는 테스트이다.
  - 객체들의 협력이 제대로 이뤄지는지 또는 비즈니스 프로세스의 흐름을 검사하는 테스트라고 볼 수 있다.
  - 연동 시스템의 장애나 예외 상황이 발생했을 때 시스템이 어떻게 반응하는지 테스트하는 역할을 하기도 한다.
- **E2E 테스트(end-toend test)**
  - 실제 사용자 시나리오에서 시스템이 어떻게 동작하는지를 검증하는 테스트이다.
  - 사용자의 실제 상황과 비슷한 환경에서 테스트가 이뤄진다.

이상적인 테스트 비율은 단위 테스트 80%, 통합 테스트 15%, E2E 테스트 5% 정도 이다.

우리는 테스트를 만들 때 단위 테스트를 가장 먼저, 가장 많이 작성해야 한다.  
이를 기반으로 통합 테스트를 작성하고, 또 이를 기반으로 E2E 테스트를 작성해야 한다.

**단위 테스트가 가장 중요**하다.

그렇다면 '단위'란 무엇이고 '단위'의 기준은 무엇인가?  
그리고 '통합'은 무엇인가?  
누군가는 '객체 간의 협력'으로 보고, 누군가는 '서버간의 협력'으로 바라본다.

이와 같이 테스트 피라미드 모델은 용어의 모호함이 있어 테스트를 정확하게 분류하지 못한다.  
이를 보완하는 '구글의 테스트 피라미드'가 존재한다.

### 구글의 테스트 피라미드
구글의 테스트 피라미드 모델에서는 단위 테스트나 통합 테스트 같은 용어를 사용하지 않는다.  
대신 대형/중형/소형 테스트라는 용어를 사용한다.

테스트의 크기에 따라 테스트를 분류한 것으로 테스트를 실행하는 데 사용되는 리소스의 크기에 따라 분류한것이다.

- **소형 테스트**
  - 단일 서버, 단일 프로세스, 단일 스레드에서 동작하며, 디스크 I/O, 블로킹 호출이 없는 테스트를 의미한다.
- **중형 테스트**
  - 단일 서버에서 동작하되 멀티 프로세스, 멀티 스레드를 사용할 수 있는 테스트를 의미한다.
- **대형 테스트**
  - 멀티 서버에서 동작하는 테스트를 의미한다.

### 테스트 분류 기준
구글이 생각하는 테스트를 구분 짓는 주요 특징
- 테스트가 결정적인가?
- 테스트의 속도가 빠른가?

구글이 생각하기에 테스트는 결정적이고 빠를수록 좋다.

### 결정적
결정적이어야 한다는 말은 테스트는 일관돼야 한다는 말과 같다.  
즉, 같은 코드를 대상으로 실행하는 테스트는 항상 같은 응답을 해야 한다는 의미이다.

아침에 실행한 테스트는 성공하고, 저녁에 실행한 테스트는 실패하면 이를 '비결정적인 테스트'라고 하고 이러한 테스트는 안티 패턴이다.  
-> 테스트의 신뢰도를 떨어뜨린다.

테스트는 결정적일수록 좋다. -> 버그 상황을 재현하기 쉬워 버그의 원인이 되는 입력이 무엇인지 바로 알 수 있기 때문이다.

#### 속도
테스트의 속도는 빨라야 한다.

테스트의 속도가 느리면 개발자들은 테스트를 실행하는데 부담을 느끼며, 관리하고 싶다는 의욕도 크게 줄어든다.

테스트를 실행하는데 부담을 느끼지 않고 자주 실행할 수 있어야 한다.  
-> 테스트의 실행 결과를 빠르게 얻을 수 있어야 한다.

**비결정적인 테스트가 만들어지는 이유**
- 테스트가 병렬 처리를 사용하는 경우
- 테스트가 디스크 I/O를 사용할 경우
- 테스트가 다른 프로세스와 통신할 경우
- 테스트가 외부 서버와 통신할 경우

**속도가 느린 테스트가 만들어지는 이유**
- 테스트가 블로킹 호출을 사용하는 경우
- 테스트가 디스크 I/O를 사용할 경우
- 테스트가 다른 프로세스와 통신할 경우
- 테스트가 외부 서버와 통신할 경우

소형 테스트의 실질적인 목표는 테스트를 결정적이고 빠른 테스트로 만드는 것에 있다.  
그래서 테스트에 디스크 I/O가 있어서도 안 되고 블로킹 호출이 있어서도 안 되는 것이다.

### 소형 테스트의 중요성

기억해둘 만한 테스트 관련 인사이트
1. 시스템에는 소형 테스트가 많아야 한다.
2. 중현 테스트나 대형 테스트가 소형 테스트보다 많아지는 것은 바람직하지 않은 현상이다.
3. 소형 테스트는 단일 스레드, 단일 프로세스, 단일 서버에서 실행되며, 디스크 I/O, 블로킹 호출이 없는 테스트이다.
4. H2를 이용한 테스트는 중형 테스트이다.
